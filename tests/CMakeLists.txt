include(CTest)
include(LibFuzzer)
enable_testing()

file(GLOB TEST_SRC "main.c")
file(GLOB TEST_HDRS "*.h")
file(GLOB TESTS ${TEST_HDRS} ${TEST_SRC})

set(TEST_BINARY_NAME ${CMAKE_PROJECT_NAME}-tests)

add_executable(${TEST_BINARY_NAME} ${TESTS})
target_link_libraries(${TEST_BINARY_NAME} PRIVATE ${CMAKE_PROJECT_NAME})
aws_set_common_properties(${TEST_BINARY_NAME})
aws_add_sanitizers(${TEST_BINARY_NAME} ${${CMAKE_PROJECT_NAME}_SANITIZERS})
target_compile_definitions(${TEST_BINARY_NAME} PRIVATE AWS_UNSTABLE_TESTING_API=1)
target_include_directories(${TEST_BINARY_NAME} PRIVATE ${CMAKE_CURRENT_LIST_DIR})

add_test(mqtt_packet_puback ${TEST_BINARY_NAME} mqtt_packet_puback)
add_test(mqtt_packet_pubrec ${TEST_BINARY_NAME} mqtt_packet_pubrec)
add_test(mqtt_packet_pubrel ${TEST_BINARY_NAME} mqtt_packet_pubrel)
add_test(mqtt_packet_pubcomp ${TEST_BINARY_NAME} mqtt_packet_pubcomp)
add_test(mqtt_packet_suback ${TEST_BINARY_NAME} mqtt_packet_suback)
add_test(mqtt_packet_unsuback ${TEST_BINARY_NAME} mqtt_packet_unsuback)
add_test(mqtt_packet_connect ${TEST_BINARY_NAME} mqtt_packet_connect)
add_test(mqtt_packet_connack ${TEST_BINARY_NAME} mqtt_packet_connack)
add_test(mqtt_packet_publish ${TEST_BINARY_NAME} mqtt_packet_publish)
add_test(mqtt_packet_subscribe ${TEST_BINARY_NAME} mqtt_packet_subscribe)
add_test(mqtt_packet_unsubscribe ${TEST_BINARY_NAME} mqtt_packet_unsubscribe)
add_test(mqtt_packet_pingreq ${TEST_BINARY_NAME} mqtt_packet_pingreq)
add_test(mqtt_packet_pingresp ${TEST_BINARY_NAME} mqtt_packet_pingresp)
add_test(mqtt_packet_disconnect ${TEST_BINARY_NAME} mqtt_packet_disconnect)
